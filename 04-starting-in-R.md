 ### Learning Objectives

 * Load external data from a .csv file into a data frame.
 * Describe what a data frame is.
 * Summarize the contents of a data frame.
 * Use indexing to subset specific portions of data frames. 
 * Describe what a factor is.
 

## Loading our data

We are investigating the impacts of a high-fat diet on maternal cecal SCFA levels during pregnancy. Our dataset is stored as a comma separated value (CSV) file. Each row holds information for a single animal and each column holds the data for one variable of interest. Make sure this file (mouse_data.csv) is saved in the /data folder of your project directory. 

| Column           | Description                                  |
|------------------|----------------------------------------------|
| mouseID          | Unique id for each mouse                     |
| diet             | which dietary group the mouse is in          |
| genotype         | The genotype of the mouse                    |
| weight_bm        | Weight at -E0.5 (before mating)              |
| weight_0         | Weight at E0.5 (day after mating)            |
| weight_10        | Weight at E10.5                              |
| weight_15        | Weight at E15.5                              |
| weight_18        | Weight at E18.5                              |
| weight_gain      | Weight gain during pregnancy                 |
| glucose          | Whole blood glucose at E18.5                 |
| n_fetus          | Number of fetuses                            |
| insulin          | Serum insulin at E18.5                       |
| TNF              | Serum TNF at E18.5                           |
| IL6              | Serum IL6 at E18.5                           |
| acetate          | Cecal acetate at E18.5                       |
| propionate       | Cecal propionate at E18.5                    |
| butyrate         | Cecal butyrate at E18.5                      |
| lactate          | Cecal lactate at E18.5                       |

### Reading the data into R

The file has now been downloaded to the destination you specified, but R has not 
yet loaded the data from the file into memory. To do this, we can use the 
`read_csv()` function from the **`tidyverse`** package. Because we are working with 
the **`ProjectTemplate`** package, the **`tidyverse`** package will be automatically 
loaded when we load out project as long as it is listed under **libraries** in our 
config file. If we had data_loading set to TRUE in the config file, it would automatically 
load this data file as well, but let's do it manually for now. 

```{r}
mouse_data <- read_csv("data/mouse_data.csv")
```

When you execute `read_csv` on a data file, it looks through the first 1000 rows 
of each column and guesses its data type. For example, in this dataset,
`read_csv()` reads `weight_bm` as `col_double` (a numeric data type), and `genotype` 
as `col_character`. You have the option to specify the data type for a column
manually by using the `col_types` argument in `read_csv`.

## What are data frames?

When we loaded the data into R, it got stored as an object of class `tibble`, 
which is a special kind of data frame (the difference is not important for our 
purposes, but you can learn more about tibbles 
[here](https://tibble.tidyverse.org/)). 
Data frames are the _de facto_ data structure for most tabular data, and what we
use for statistics and plotting.
Data frames can be created by hand, but most commonly they are generated by
functions like `read_csv()`; in other words, when importing
spreadsheets from your hard drive or the web.

A data frame is the representation of data in the format of a table where the
columns are vectors that all have the same length. Because columns are
vectors, each column must contain a single type of data (e.g., characters, integers,
factors).

## Inspecting data frames

We already saw how the functions `head()` and `str()` can be useful to check the
content and the structure of a data frame. Here is a non-exhaustive list of
functions to get a sense of the content/structure of the data. Let's try them out!

* Size:
    * `dim(surveys)` - returns a vector with the number of rows in the first element,
          and the number of columns as the second element (the **dim**ensions of
          the object)
    * `nrow(surveys)` - returns the number of rows
    * `ncol(surveys)` - returns the number of columns

* Content:
    * `head(surveys)` - shows the first 6 rows
    * `tail(surveys)` - shows the last 6 rows

* Names:
    * `names(surveys)` - returns the column names (synonym of `colnames()` for `data.frame`
	   objects)
    * `rownames(surveys)` - returns the row names

* Summary:
    * `str(surveys)` - structure of the object and information about the class, length and
	   content of  each column
    * `summary(surveys)` - summary statistics for each column

Note: most of these functions are "generic", they can be used on other types of
objects besides `data.frame`.

## Subsetting data frames

Our survey data frame has rows and columns (it has 2 dimensions), if we want to
extract some specific data from it, we need to specify the "coordinates" we
want from it. Row numbers come first, followed by column numbers. However, note
that different ways of specifying these coordinates lead to results with
different classes.

```{r}
# For instance, to select all columns for the first row:
surveys[1, ]
# The same shortcut works for rows --
# To select the first column across all rows:
surveys[, 1]
# An even shorter way to select first column across all rows:
surveys[1] # No comma! 
```

You can also exclude certain indices of a data frame using the "`-`" sign:

```{r, purl=FALSE}
surveys[, -1]                 # The whole data frame, except the first column
```

Data frames can be subset by calling indices (as shown previously), but also by calling their column names directly. 
In RStudio, you can use the autocompletion feature to get the full and correct names of the columns.

```{r}
# As before, using single brackets returns a data frame:
surveys["species_id"]
surveys[, "species_id"]
# Double brackets returns a vector:
surveys[["species_id"]]
# We can also use the $ operator with column names instead of double brackets
# This returns a vector:
surveys$species_id
```

## Factors

When we did `str(surveys)` we saw that several of the columns consist of
integers. The columns `genotype` and `diet`, however, are
of the class `character`.
These columns contain categorical data, that is, they can only take on
a limited number of values. 

R has a special class for working with categorical data, called `factor`. 
Factors are very useful and actually contribute to making R particularly well 
suited to working with data. So we are going to spend a little time introducing 
them.

Once created, factors can only contain a pre-defined set of values, known as
*levels*. 

When importing a data frame with `read_csv()`, the columns that contain text are not automatically coerced (=converted) into the `factor` data type, but once we have
loaded the data we can do the conversion using the `factor()` function: 

```{r}
mouse_data$diet <- factor(mouse_data$diet)
```

We can see that the conversion has worked by using the `summary()` 
function again. This produces a table with the counts for each factor level:

```{r}
summary(mouse_data$diet)
```

## Data manipulation in the Tidyverse

Bracket subsetting is handy, but it can be cumbersome and difficult to read,
especially for complicated operations.

The **`tidyverse`** package tries to address 3 common issues that arise when
doing data analysis in R:

1. The results from a base R function sometimes depend on the type of data.
2. R expressions are used in a non standard way, which can be confusing for new
   learners.
3. The existence of hidden arguments having default operations that new learners are not aware
   of.
   
  Next, we're going to learn some of the most common **`Tidyverse`** functions:

- `select()`: subset columns
- `filter()`: subset rows on conditions
- `mutate()`: create new columns by using information from other columns

## Pipes

Pipes let you take
the output of one function and send it directly to the next, which is useful
when you need to do many things to the same dataset.  Pipes in R look like
`%>%` and are made available via the **`magrittr`** package, installed automatically
with the **`Tidyverse`**. If you use RStudio, you can type the pipe with 
<kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>M</kbd> if you have a PC or <kbd>Cmd</kbd> +
<kbd>Shift</kbd> + <kbd>M</kbd> if you have a Mac.

## Selecting columns and filtering rows

To select columns of a data frame, use `select()`. The first argument
to this function is the data frame (`mouse_data`), and the subsequent
arguments are the columns to keep.

```{r}
mouse_data %>%
	select(mouseID, acetate, butyrate, propionate, lactate)
```

To select all columns *except* certain ones, put a "-" in front of
the variable to exclude it.

```{r}
mouse_data %>%
	select(-TNF)
```

To choose rows based on a specific criterion, use `filter()`:

```{r}
mouse_data %>%
	filter(diet == "C")
```

## Mutate

Frequently you'll want to create new columns based on the values in existing
columns, for example to do unit conversions, or to find the ratio of values in two
columns. For this we'll use `mutate()`.

To create a new column of weight in kg

```{r}
mouse_data <- mouse_data %>%
  mutate(weight_bm_kg = weight_bm / 1000)
```


Adapted from https://github.com/datacarpentry/R-ecology-lesson/blob/main/02-starting-with-data.Rmd
